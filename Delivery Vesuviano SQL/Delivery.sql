-- Zona
CREATE TABLE ZONA (
    ID_ZONA CHAR(4),
    PRIMARY KEY (ID_ZONA)
);

-- Comune
CREATE TABLE COMUNE
(
  NOME_COMUNE    CHAR(20),
  PROVINCIA      CHAR(2),
  ZONA_ASSOCIATA CHAR(4),
  PRIMARY KEY (NOME_COMUNE),
  FOREIGN KEY (ZONA_ASSOCIATA) REFERENCES ZONA (ID_ZONA)
);

-- Locale
CREATE TABLE LOCALE
(
  P_IVA             CHAR(11),
  NOME_LOCALE       VARCHAR(20) UNIQUE NOT NULL,
  N_TELEFONO_LOCALE CHAR(10) UNIQUE NOT NULL,
  VIA_LOCALE        VARCHAR(20) NOT NULL,
  CAP_LOCALE        VARCHAR(20) NOT NULL,
  COMUNE_SEDE       CHAR(20),
  PRIMARY KEY (P_IVA),
  FOREIGN KEY (COMUNE_SEDE) REFERENCES COMUNE (NOME_COMUNE)
);

-- Rider
CREATE TABLE RIDER
(
  CF_RIDER          CHAR(16),
  NOME_RIDER        VARCHAR(20) NOT NULL,
  COGNOME_RIDER     VARCHAR(20) NOT NULL,
  RIDER_ID          INT(4) NOT NULL UNIQUE,
  TELEFONO_RIDER    CHAR(10) UNIQUE,
  COMUNE_LAVORATIVO CHAR(20),
  PRIMARY KEY (CF_RIDER),
  FOREIGN KEY (COMUNE_LAVORATIVO) REFERENCES COMUNE (NOME_COMUNE)
);

-- PRENOTAZIONE
CREATE TABLE PRENOTAZIONE
(
  ANNO              INT(4) NOT NULL,
  DATA_PRENOTAZIONE DATE,
  GIORNO            VARCHAR(20) NOT NULL,
  ORA_INIZIO        TIMESTAMP NOT NULL,
  ORA_FINE          TIMESTAMP NOT NULL,
  PRIMARY KEY (ANNO, DATA_PRENOTAZIONE, GIORNO),
  CHECK (
      (HOUR(ORA_INIZIO) >= 19 AND HOUR(ORA_FINE) <= 24)
      AND
      (HOUR(ORA_INIZIO) < HOUR(ORA_FINE))),
  CHECK (GIORNO IN
         ('LUNEDI', 'MARTEDI', 'MERCOLEDI', 'GIOVEDI', 'VENERDI', 'SABATO', 'DOMENICA'))
);

-- Cliente
CREATE TABLE CLIENTE
(
  NOME_CLIENTE    VARCHAR(20) NOT NULL,
  COGNOME_CLIENTE VARCHAR(20),
  EMAIL           CHAR(30) NOT NULL,
  COMUNE_RES      CHAR(20),
  PRIMARY KEY (EMAIL),
  FOREIGN KEY (COMUNE_RES) REFERENCES COMUNE (NOME_COMUNE)
);

-- PAGAMENTO
CREATE TABLE PAGAMENTO
(
  SCONTRINO  CHAR(10),
  IMPORTO    INT(2),
  METODO_PAY VARCHAR(30),
  PRIMARY KEY (SCONTRINO),
  CHECK (
        METODO_PAY = 'CONTANTI'
      OR METODO_PAY = 'CARTA DI CREDITO/DEBITO')
);

-- Informazioni consegna
CREATE TABLE INFORMAZIONI_CONSEGNA
(
  VIA_CLIENTE    CHAR(20) NOT NULL,
  CITTA_CLIENTE  CHAR(20) NOT NULL,
  CAP_CLIENTE    CHAR(10) NOT NULL,
  CITOFONO       VARCHAR(20),
  NOTE_PER_RIDER VARCHAR(30),
  EMAIL_CLIENTE  CHAR(30),
  PRIMARY KEY (VIA_CLIENTE, CITTA_CLIENTE, CAP_CLIENTE),
  FOREIGN KEY (EMAIL_CLIENTE) REFERENCES CLIENTE (EMAIL)
);

-- ORDINE
CREATE TABLE ORDINE
(
  N_ORDINE           INT(3) NOT NULL,
  STATO              VARCHAR(20) NOT NULL,
  P_IVALOCALE        CHAR(11),
  CF_CONSEGNATORE    CHAR(16),
  EMAIL_DESTINATARIO CHAR(30),
  SCONTRINO_ORDINE   CHAR(10),
  DATA_E_ORA         TIMESTAMP,
  PRIMARY KEY (N_ORDINE),
  FOREIGN KEY (P_IVALOCALE) REFERENCES LOCALE (P_IVA),
  FOREIGN KEY (CF_CONSEGNATORE) REFERENCES RIDER (CF_RIDER),
  FOREIGN KEY (EMAIL_DESTINATARIO) REFERENCES CLIENTE (EMAIL),
  FOREIGN KEY (SCONTRINO_ORDINE) REFERENCES PAGAMENTO (SCONTRINO),
  CHECK (
      STATO IN ('IN LAVORAZIONE', 'RITIRATO', 'IN CONSEGNA', 'CONSEGNATO'))
);

-- Prodotto
CREATE TABLE PRODOTTO
(
  ID_PRODOTTO   INT NOT NULL,
  NOME_PRODOTTO VARCHAR(20) NOT NULL,
  TIPO_PRODOTTO VARCHAR(20),
  P_IVA_LOCALE  CHAR(11),
  PRIMARY KEY (ID_PRODOTTO),
  FOREIGN KEY (P_IVA_LOCALE) REFERENCES LOCALE (P_IVA)
);

-- Presenti
CREATE TABLE PRESENTI
(
  IDPRODOTTO INT,
  NORDINE    INT,
  QUANTITA   INT(2),
  PRIMARY KEY (IDPRODOTTO, NORDINE),
  FOREIGN KEY (IDPRODOTTO) REFERENCES PRODOTTO (ID_PRODOTTO),
  FOREIGN KEY (NORDINE) REFERENCES ORDINE (N_ORDINE)
);

-- Effettuano
CREATE TABLE EFFETTUANO
(
  CODF_RIDER        CHAR(16),
  ANNO1             INT(4),
  DATAPRENOTAZIONE  DATE,
  GIORNO_LAVORATIVO VARCHAR(20),
  PRIMARY KEY (CODF_RIDER, ANNO1, DATAPRENOTAZIONE, GIORNO_LAVORATIVO),
  FOREIGN KEY (CODF_RIDER) REFERENCES RIDER (CF_RIDER),
  FOREIGN KEY (ANNO1, DATAPRENOTAZIONE, GIORNO_LAVORATIVO) REFERENCES PRENOTAZIONE (ANNO, DATA_PRENOTAZIONE, GIORNO)
);
